{% extends "base.html" %}

{% block title %}处理中 Processing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h2 class="text-center mb-0">
                    <i class="bi bi-hourglass-split me-2"></i>
                    翻译处理中 Translation in Progress
                </h2>
            </div>
            <div class="card-body p-4 text-center">
                <div class="my-5">
                    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    
                    <h3 class="mt-4" id="status-text">
                        {% if status == "queued" %}
                            正在排队 Queued
                        {% elif status == "processing" %}
                            正在处理 Processing
                        {% else %}
                            正在检查状态 Checking status
                        {% endif %}
                    </h3>
                    
                    <p class="text-muted mt-3" id="waiting-text">
                        请耐心等待，PDF翻译需要一些时间。请不要关闭此页面。
                        <br>
                        Please wait patiently, PDF translation takes some time. Please do not close this page.
                    </p>
                </div>
                
                <div class="progress mb-4" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                
                <div id="error-container" class="alert alert-danger d-none">
                    <h4><i class="bi bi-exclamation-triangle-fill"></i> 翻译出错 Translation Error</h4>
                    <p id="error-message"></p>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary mt-2">
                        <i class="bi bi-arrow-repeat"></i> 尝试重新翻译 Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variables
    const jobId = "{{ job_id }}";
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const waitingText = document.getElementById('waiting-text');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    
    // Progress animation
    let progress = 0;
    let progressInterval;
    
    function startProgress() {
        progressInterval = setInterval(function() {
            // Slower progression as we get closer to 90%
            if (progress < 30) {
                progress += 2;
            } else if (progress < 60) {
                progress += 1;
            } else if (progress < 90) {
                progress += 0.3;
            }
            
            if (progress > 90) {
                progress = 90; // Cap at 90% until we know it's complete
            }
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = Math.round(progress) + '%';
        }, 1000);
    }
    
    // Start progress animation
    startProgress();
    
    // Check status every 3 seconds
    function checkStatus() {
        fetch('/check_status/' + jobId)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    // Translation completed successfully
                    clearInterval(progressInterval);
                    progress = 100;
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                    progressBar.textContent = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                    
                    statusText.innerHTML = '翻译完成！即将跳转到结果页面...<br>Translation completed! Redirecting to result page...';
                    
                    // Redirect to result page after a short delay
                    setTimeout(function() {
                        window.location.href = '/result/' + data.output_filename;
                    }, 1500);
                }
                else if (data.status === 'failed') {
                    // Translation failed
                    clearInterval(progressInterval);
                    progressBar.className = 'progress-bar bg-danger';
                    progressBar.classList.remove('progress-bar-animated');
                    
                    statusText.textContent = '翻译失败 Translation Failed';
                    waitingText.style.display = 'none';
                    
                    errorMessage.textContent = data.error || '未知错误 Unknown error';
                    errorContainer.classList.remove('d-none');
                }
                else if (data.status === 'processing') {
                    // Still processing
                    statusText.textContent = '正在处理 Processing';
                }
                else if (data.status === 'queued') {
                    // Still in queue
                    statusText.textContent = '正在排队 Queued';
                }
                else if (data.status === 'not_found') {
                    // Job not found
                    clearInterval(progressInterval);
                    progressBar.className = 'progress-bar bg-danger';
                    
                    statusText.textContent = '任务未找到 Job Not Found';
                    errorMessage.textContent = '翻译任务不存在或已过期 Translation job does not exist or has expired';
                    errorContainer.classList.remove('d-none');
                    waitingText.style.display = 'none';
                }
                
                // If job is still in progress, check again in 3 seconds
                if (data.status === 'processing' || data.status === 'queued') {
                    setTimeout(checkStatus, 3000);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                // Try again in 5 seconds
                setTimeout(checkStatus, 5000);
            });
    }
    
    // Start checking status
    setTimeout(checkStatus, 1000);
</script>
{% endblock %} 